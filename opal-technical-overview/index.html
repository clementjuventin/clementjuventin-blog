<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.0">
<title data-rh="true">Opal - Technical Overview | ClÃ©ment Juventin</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Opal - Technical Overview | ClÃ©ment Juventin"><meta data-rh="true" name="description" content="In this article, Iâ€™ll dive into the technical underpinnings of the Opal protocol, a project Iâ€™ve contributed to extensively. If you havenâ€™t yet read the previous article about Opal, I recommend starting there to better understand the context of what follows."><meta data-rh="true" property="og:description" content="In this article, Iâ€™ll dive into the technical underpinnings of the Opal protocol, a project Iâ€™ve contributed to extensively. If you havenâ€™t yet read the previous article about Opal, I recommend starting there to better understand the context of what follows."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-01-23T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://linkedin.com/in/clÃ©ment-juventin-ab81841a3/"><meta data-rh="true" property="article:tag" content="Opal,Technical,Web3"><link data-rh="true" rel="icon" href="/clementjuventin-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview"><link data-rh="true" rel="alternate" href="https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview","mainEntityOfPage":"https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview","url":"https://clementjuventin.github.io/clementjuventin-blog/opal-technical-overview","headline":"Opal - Technical Overview","name":"Opal - Technical Overview","description":"In this article, Iâ€™ll dive into the technical underpinnings of the Opal protocol, a project Iâ€™ve contributed to extensively. If you havenâ€™t yet read the previous article about Opal, I recommend starting there to better understand the context of what follows.","datePublished":"2025-01-23T00:00:00.000Z","author":{"@type":"Person","name":"ClÃ©ment Juventin","description":"Internet traveler ðŸ¤–â€‹","url":"https://linkedin.com/in/clÃ©ment-juventin-ab81841a3/","image":"https://github.com/clementjuventin.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://clementjuventin.github.io/clementjuventin-blog/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/clementjuventin-blog/rss.xml" title="ClÃ©ment Juventin RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/clementjuventin-blog/atom.xml" title="ClÃ©ment Juventin Atom Feed"><link rel="stylesheet" href="/clementjuventin-blog/assets/css/styles.025c4f56.css">
<script src="/clementjuventin-blog/assets/js/runtime~main.38e420fc.js" defer="defer"></script>
<script src="/clementjuventin-blog/assets/js/main.4233378f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="https://github.com/clementjuventin.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_kYj5" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/clementjuventin-blog/"><b class="navbar__title text--truncate">ClÃ©ment Juventin</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/clementjuventin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_VFyZ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_Bdbm colorModeToggle_OJqu"><button class="clean-btn toggleButton_uvTa toggleButtonDisabled_Ef_J" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_GRyc lightToggleIcon_bN1_"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_GRyc darkToggleIcon_NHiB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_GRyc systemToggleIcon_F5ss"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_qIFn"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_asJl"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_xXWV thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_tOeK margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_lVDx">2025</h3><ul class="sidebarItemList_OGFZ clean-list"><li class="sidebarItem_Q7s7"><a class="sidebarItemLink_DEAP" href="/clementjuventin-blog/building-an-arbitrager">Building an Arbitrage Bot</a></li><li class="sidebarItem_Q7s7"><a class="sidebarItemLink_DEAP" href="/clementjuventin-blog/degen-to-sniper">From A Nooby Degen to a Bloodthirsty Sniper</a></li><li class="sidebarItem_Q7s7"><a aria-current="page" class="sidebarItemLink_DEAP sidebarItemLinkActive_lF7Q" href="/clementjuventin-blog/opal-technical-overview">Opal - Technical Overview</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_lVDx">2024</h3><ul class="sidebarItemList_OGFZ clean-list"><li class="sidebarItem_Q7s7"><a class="sidebarItemLink_DEAP" href="/clementjuventin-blog/opal">Opal - Yield DApp built on top of Balancer V2</a></li><li class="sidebarItem_Q7s7"><a class="sidebarItemLink_DEAP" href="/clementjuventin-blog/request-throttler">Tackling Rate Limiting, One of My First Challenges at Cede Labs</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_rsdE">Opal - Technical Overview</h1><div class="container_w7Ve margin-vert--md"><time datetime="2025-01-23T00:00:00.000Z">January 23, 2025</time> Â· <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Tp4l"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/clementjuventin-blog/authors/clementjuventin"><img class="avatar__photo authorImage_CL_O" src="https://github.com/clementjuventin.png" alt="ClÃ©ment Juventin"></a><div class="avatar__intro authorDetails_xwdW"><div class="avatar__name"><a href="/clementjuventin-blog/authors/clementjuventin"><span class="authorName_FnlL">ClÃ©ment Juventin</span></a></div><small class="authorTitle_KapK" title="Internet traveler ðŸ¤–â€‹">Internet traveler ðŸ¤–â€‹</small><div class="authorSocials_G9TQ"><a href="https://www.linkedin.com/in/clementjuventin/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_GZLt" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_GZLt"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://github.com/clementjuventin" target="_blank" rel="noopener noreferrer" class="authorSocialLink_GZLt" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_GZLt githubSvg_nkVx"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>In this article, Iâ€™ll dive into the <strong>technical underpinnings of the Opal protocol</strong>, a project Iâ€™ve contributed to extensively. If you havenâ€™t yet read the previous article about Opal, I recommend starting <a href="/clementjuventin-blog/opal">there</a> to better understand the context of what follows.</p>
<p>Here, weâ€™ll focus on two of the protocolâ€™s most important smart contracts: the <strong>Omnipool</strong> and the <strong>Reward Manager</strong>.</p>
<p>The Omnipool is the core of the protocolâ€”itâ€™s a single-asset liquidity pool that can dynamically rebalance and reallocate funds across different strategies. It lies at the heart of Opalâ€™s yield-generation mechanism and represents the foundation of the platform&#x27;s financial logic.</p>
<p>The second contract, the Reward Manager, is one I developed almost entirely independently. Its role is to handle the distribution of rewards to users participating in the Omnipool. I find the mathematical model behind it particularly elegant and effective. While similar systems are likely common and well-studied in DeFi, in this article, weâ€™ll take a closer look at Opalâ€™s unique implementation.</p>
<h2 class="anchor anchorWithStickyNavbar_m2y2" id="protocol-overview">Protocol Overview<a href="#protocol-overview" class="hash-link" aria-label="Direct link to Protocol Overview" title="Direct link to Protocol Overview">â€‹</a></h2>
<p><img decoding="async" loading="lazy" alt="Protocol Overview" src="/clementjuventin-blog/assets/images/opal_design-7f73eeb59cedf3229fea96481a5e6e3c.png" width="902" height="510" class="img_Gz92"></p>
<p>This diagram is a simplified version of the Opal protocol, highlighting the <strong>flow of liquidity and rewards</strong> managed by the protocol.</p>
<p>The typical operation of an omnipool is as follows:</p>
<ul>
<li>For an omnipool that accepts an underlying asset A, the governance module proposes a set of pools along with a distribution weight for the liquidity.</li>
<li>Liquidity deposited into the omnipool is allocated according to these weights.</li>
<li>If the current underlying pool weights deviate from those voted by the governance module, an incentive in GEM (the governance token) is distributed to reward rebalancing. The pool weights represents the relative share of the liquidity allocated to each underlying pool.</li>
<li>Over time, the omnipool accrues rewards, which are tracked by the Reward Manager.</li>
<li>When a user withdraws their liquidity or chooses to claim their rewards, the Reward Manager distributes the appropriate amount.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_m2y2" id="the-omnipool">The Omnipool<a href="#the-omnipool" class="hash-link" aria-label="Direct link to The Omnipool" title="Direct link to The Omnipool">â€‹</a></h2>
<p>Letâ€™s start by examining the main method of the omnipool: <strong>the deposit method</strong>.</p>
<blockquote>
<p>As a general note for this article: in all code snippets, I systematically remove uninteresting sections such as parameter validation to improve readability.</p>
</blockquote>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">depositFor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint256</span><span class="token plain"> _amountIn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token plain"> _depositFor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> _minLpReceived</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the price of the underlying asset in USD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> underlyingPrice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oracle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUSDPrice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">underlyingToken</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Estimate the value in USD of the liquidity in the omnipool before the deposit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> beforeTotalUnderlying </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_getTotalAndPerPoolUnderlying</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">underlyingPrice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Transfer underlying token to this contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    underlyingToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">safeTransferFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _amountIn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Estimate the current exchange rate of the omnipool (ie. how much LP tokens are minted for each underlying token deposited)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> exchangeRate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_exchangeRate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beforeTotalUnderlying</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Deposit into Aura Finance (and Balancer V2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_depositToAura</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beforeTotalUnderlying</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _amountIn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Estimate the new value of the liquidity in the omnipool after the deposit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> afterTotalUnderlying </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_getTotalAndPerPoolUnderlying</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">underlyingPrice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Calculate the increase in the value of the liquidity in the omnipool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> underlyingBalanceIncrease </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> afterTotalUnderlying </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> beforeTotalUnderlying</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Calculate the amount of LP tokens that can be minted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> mintableUnderlyingAmount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_amountIn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> underlyingBalanceIncrease</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> lpReceived </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mintableUnderlyingAmount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">divDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchangeRate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Slippage protection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lpReceived </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> _minLpReceived</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">revert</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TooMuchSlippage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lpToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_depositFor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpReceived</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _depositFor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Handle rebalancing rewards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_handleRebalancingRewards</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Emit an event to notify the outside world</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Deposit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_depositFor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _amountIn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpReceived</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You&#x27;ll immediately notice a key feature of contracts dealing with omnipools: <strong>everything is denominated in USD</strong>, thanks to oracles.
Indeed, to maintain a fair balance across multiple underlying pools, it&#x27;s absolutely essential to <strong>accurately price the current value of all positions held by the omnipool</strong>.</p>
<p>Opal relies heavily on oracle usage. Every token in every underlying pool must have a reliable price oracle.</p>
<p>This introduces a natural limitation: <strong>it&#x27;s not possible to farm liquidity pools with low market cap tokens</strong>, as they often lack trustworthy oracles. Generally, these tokens offer higher APRs because they carry more risk. It&#x27;s unfortunate to miss out on such opportunities, but this restriction is necessary to ensure the protocolâ€™s overall security.</p>
<p>To conclude on the oracle topic, note that Opal is restricted to use <a href="https://data.chain.link/streams" target="_blank" rel="noopener noreferrer">Chainlink</a> and <a href="https://app.redstone.finance/app/tokens/?tokenTypes=crypto" target="_blank" rel="noopener noreferrer">Redstone</a> feeds. These lists define the full range of tokens eligible for integration into new underlying pools.</p>
<p>To estimate the value of a position held by the omnipool, we rely on:</p>
<ul>
<li>the USD price of each token forming the underlying Balancer pool, and</li>
<li>the math provided in the Balancer documentation, which governs pool behavior.</li>
</ul>
<p><a href="https://github.com/balancer/docs/blob/main/docs/concepts/advanced/valuing-bpt/valuing-bpt.md#on-chain-price-evaluation" target="_blank" rel="noopener noreferrer">This document</a> provides a detailed explanation of the math used to estimate the value of a Balancer Pool Token (BPT).</p>
<p>As for the rest, I wonâ€™t go deeper into the omnipool methods in this article.
However, if you&#x27;re interested in exploring the full implementation, the smart contract code is publicly available on <a href="https://etherscan.io/address/0x50953a9842b1fe42db077f1b850ec365a25f9d8e#code" target="_blank" rel="noopener noreferrer">Etherscan</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_m2y2" id="the-reward-manager">The Reward Manager<a href="#the-reward-manager" class="hash-link" aria-label="Direct link to The Reward Manager" title="Direct link to The Reward Manager">â€‹</a></h2>
<p>Letâ€™s now discuss the <strong>Reward Manager</strong> â€” a key module responsible for distributing rewards to users.</p>
<p>More specifically, the rewards accumulated by the omnipool are distributed by Balancer and Aura Finance in the form of their respective governance tokens: <code>BAL</code> and <code>AURA</code>.</p>
<p>In some cases, external protocols may incentivize users to provide liquidity by offering extra rewards. These are one-off or special tokens distributed in addition to <code>BAL</code> and <code>AURA</code>. For simplicity, the following examples focus only on handling <code>BAL</code> tokens, but the logic can be duplicated to support any other reward token.</p>
<p>Itâ€™s also worth noting a crucial difference from Uniswap:
In Uniswap, a liquidity pool A/B typically distributes claimable rewards in both token A and B.
In Balancer V2, however, profits are directly reinvested into the BPT (Balancer Pool Tokens), increasing their intrinsic value.</p>
<p>This means thereâ€™s no need to redistribute LP token rewards â€” only the reward tokens emitted by the underlying protocols integrated into Opal.</p>
<h3 class="anchor anchorWithStickyNavbar_m2y2" id="modeling-and-distributing-rewards">Modeling and Distributing Rewards<a href="#modeling-and-distributing-rewards" class="hash-link" aria-label="Direct link to Modeling and Distributing Rewards" title="Direct link to Modeling and Distributing Rewards">â€‹</a></h3>
<p>Before diving into the code, letâ€™s break down the <strong>mathematical model</strong> behind reward accumulation and distribution.</p>
<p>To accurately track the rewards accrued by the omnipool over time, we use a mathematical integral â€” denoted as R (for Rewards). An integral is monotonic and non-decreasing, which perfectly matches our use case:</p>
<blockquote>
<p>The omnipool can only accumulate rewards over time, never lose them.</p>
</blockquote>
<p>To be more precise, R expresses the values of one unit of LP token in the omnipool over time.</p>
<p>As a simplified example, imagine a linear curve representing R over time â€” a case where the omnipool receives a constant flow of rewards and is updated at each block:</p>
<p><img decoding="async" loading="lazy" alt="Rewards Curve" src="/clementjuventin-blog/assets/images/reward_curve-dfecc95cef03ff4782a8a2ad48fd5049.png" width="1200" height="800" class="img_Gz92"></p>
<blockquote>
<p><code>R(t) = constant Ã— t</code> (very simple case). Source Desmos.</p>
</blockquote>
<p>When a user joins the omnipool, we need to store the value <code>R(t)</code> at that moment, representing the accumulated rewards before their participation.</p>
<p>When the user decides to claim their rewards, we simply:</p>
<ul>
<li>Retrieve the current reward state <code>R(t+1)</code></li>
<li>Subtract the value at their join time <code>R(t)</code></li>
<li>Compute the reward delta: <code>reward = R(t+1) - R(t)</code></li>
</ul>
<p>This delta is always â‰¥ 0 and represents the rewards accrue by one unit of the LP token in the omnipool at <code>t+1</code> minus the value at <code>t</code>.</p>
<p><img decoding="async" loading="lazy" alt="Rewards Curve User" src="/clementjuventin-blog/assets/images/reward_curve_user-34b2557c91f402302ea8ea91efd89cbf.png" width="1200" height="800" class="img_Gz92"></p>
<blockquote>
<p>On this diagram, <code>t=5</code> and <code>t+1=10</code>. The rewards accrued by one unit of the LP token in the omnipool between <code>t</code> and <code>t+1</code> is <code>R(t+1) - R(t) = 10 - 5 = 5</code>. Source Desmos.</p>
</blockquote>
<p>Now, the remaining step is to distribute the rewards among liquidity providers proportionally to their share in the pool. This share is known, as it directly corresponds to their current balance. The final formula is:</p>
<p><code>reward = balance * (R(t+1) - R(t))</code> (we don&#x27;t see <code>totalSupply</code> in the formula because it&#x27;s contained in <code>R</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_m2y2" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">â€‹</a></h3>
<p>Now that we have been through the mathematical model, let&#x27;s take a look at the <code>updateUserState</code> function, which is called whenever a user deposits or claims rewards. It updates both the global omnipool state and the individual userâ€™s reward data:</p>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateUserState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token plain"> _account</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the user&#x27;s LP balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> deposited </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> omnipool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balanceOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_account</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the pool state, claim rewards, and transfer them to the Reward Manager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_updateOmnipoolState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the user&#x27;s pending rewards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_updateRewards</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deposited</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The logic is straightforward, let&#x27;s see what&#x27;s inside of <code>_updateOmnipoolState</code>:</p>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_updateOmnipoolState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">internal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Claim rewards accrued from underlying protocols</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> earnedBAL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_claimOmnipoolRewards</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the total amount of LP tokens deposited into the omnipool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> totalDeposited </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> omnipool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">totalSupply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the global reward state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">earnedIntegral </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">earnedBAL </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> SCALED_ONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> totalDeposited</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastEarned </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> earnedBAL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the last balance of BAL in the omnipool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastBALBalance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IERC20</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balanceOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">omnipool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Emit an event to notify the claimed rewards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RewardUpdated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">earnedBAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Here we perform:</p>
<ul>
<li>Reward collection via _claimOmnipoolRewards()</li>
<li>Update of the reward integral (R) for the BAL token. As we can see, <code>BALMeta.earnedIntegral</code> represents the earned BAL rewards devided by the total supply of LP tokens (ie. the reward accrued by one unit of LP token).</li>
<li>Update of the last balance of BAL in the omnipool</li>
</ul>
<p>You probably noticed that <code>BALMeta</code> is a struct used to store reward accounting data for a specific token â€” in this case, BAL. See the full struct below:</p>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">RewardMeta</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> earnedIntegral</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// a scaled running total of reward per unit of LP token (R)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> lastEarned</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the last total amount of reward received</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">mapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> accountIntegral</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the value of R at the time of the user&#x27;s last update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">mapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> accountShare</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// amount of reward to distribute to the user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>It stores both global and per-user reward accounting data.</p>
<p>Finally, let&#x27;s take a look at the <code>_updateRewards</code> function, which updates the user&#x27;s reward share and integral:</p>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_updateRewards</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">internal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the difference between the global and per-user reward integral (ie. R(t+1) - R(t))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> BALIntegralDelta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">earnedIntegral </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accountIntegral</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Calculate the amount of reward to distribute to the user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> balShare </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> BALIntegralDelta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> SCALED_ONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the user&#x27;s reward share</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accountShare</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> balShare</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the user&#x27;s reward integral</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accountIntegral</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">earnedIntegral</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Emit an event to notify the claimed rewards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RewardUpdated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BALIntegralDelta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This logic ensures:</p>
<ul>
<li>Users only earn rewards for periods where they were actively staked</li>
<li>The reward share is fairly proportional to their balance and holding duration</li>
</ul>
<p>The final piece of the puzzle is the <code>claimEarnings</code> function. It updates the state of the omnipool and the user, then transfers the accrued rewards to the user&#x27;s address.</p>
<div class="language-solidity codeBlockContainer_AfQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oi8h"><pre tabindex="0" class="prism-code language-solidity codeBlock_o8hW thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_kW6b"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">claimEarnings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">external</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Update the user&#x27;s reward state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">updateUserState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the share amounts and reset them to 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> balAmount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accountShare</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALMeta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accountShare</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Transfer the rewards to the user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BALToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">safeTransferFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balAmount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastBALBalance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IERC20</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balanceOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RewardClaimed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balAmount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You can find the full implementation of the Reward Manager <a href="https://etherscan.io/address/0xc1094a067b862e57678c4bd5e9d27ed2bd4be937#code" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_m2y2" id="toward-a-more-concrete-example">Toward a More Concrete Example<a href="#toward-a-more-concrete-example" class="hash-link" aria-label="Direct link to Toward a More Concrete Example" title="Direct link to Toward a More Concrete Example">â€‹</a></h3>
<p>Now that you&#x27;ve seen the mathematical model and its implementation, I just wanted to show you a more realistic example to keep in mind.</p>
<p>In the graph below, we represent the evolution of <code>R(t)</code>. As you can see, the progression takes the form of a step function. This is because the accrued rewards are only updated from the Reward Managerâ€™s perspective when the corresponding functions are called.</p>
<p>Additionally, the evolution of <code>R(t)</code> is not linear. It depends on both the liquidity of the omnipool and the APRs of the underlying pools that compose it.</p>
<p><img decoding="async" loading="lazy" alt="Rewards Curve Example" src="/clementjuventin-blog/assets/images/reward_curve_complex-a1f46dc1930dae94befbad4d294bc27f.png" width="1200" height="800" class="img_Gz92"></p>
<blockquote>
<p><code>R(t)</code> more realistic evolution. Source Desmos.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_m2y2" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â€‹</a></h2>
<p>Let&#x27;s wrap up this article on the inner workings of the Omnipool and the Reward Manager. I hope it helped you gain a better understanding of the Opal protocol and introduced you to some interesting mechanisms you might consider for your own future work. There are other noteworthy components we havenâ€™t covered here, such as the governance module and the rebalancing systemâ€”areas Iâ€™ve been less involved with. But perhaps thatâ€™ll be a good reason to write a second article. See you soon!</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_aLRf padding--none margin-left--sm"><li class="tag_MC4v"><a rel="tag" title="Opal articles" class="tag_PxKz tagRegular_ozuG" href="/clementjuventin-blog/tags/opal">Opal</a></li><li class="tag_MC4v"><a rel="tag" title="Technical articles" class="tag_PxKz tagRegular_ozuG" href="/clementjuventin-blog/tags/technical">Technical</a></li><li class="tag_MC4v"><a rel="tag" title="Web3 related projects" class="tag_PxKz tagRegular_ozuG" href="/clementjuventin-blog/tags/web3">Web3</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/clementjuventin-blog/degen-to-sniper"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">From A Nooby Degen to a Bloodthirsty Sniper</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/clementjuventin-blog/opal"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Opal - Yield DApp built on top of Balancer V2</div></a></nav></main><div class="col col--2"><div class="tableOfContents_g27u thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#protocol-overview" class="table-of-contents__link toc-highlight">Protocol Overview</a></li><li><a href="#the-omnipool" class="table-of-contents__link toc-highlight">The Omnipool</a></li><li><a href="#the-reward-manager" class="table-of-contents__link toc-highlight">The Reward Manager</a><ul><li><a href="#modeling-and-distributing-rewards" class="table-of-contents__link toc-highlight">Modeling and Distributing Rewards</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li><li><a href="#toward-a-more-concrete-example" class="table-of-contents__link toc-highlight">Toward a More Concrete Example</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div></div>
</body>
</html>